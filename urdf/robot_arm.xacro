<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="robot_arm">


    <!-- Define Macros -->

    <!-- Servo with MBracket Macro -->
    <xacro:macro name="servo" params="index flipped">
        <link name="servo_${index}">
            <visual>
                <origin xyz="0 0 0.26" rpy="0 0 0"/>
                <geometry>
                    <mesh filename="file://$(find robot_arm_teleop)/servo.stl" scale="0.01 0.01 0.01"/>
                </geometry>
            </visual>
        </link> 

        <link name="mbracket_${index}">
            <visual>
                <origin xyz="${-0.145*flipped} 0.1 0.185" rpy="${pi/2} 0 ${(pi/2)*flipped}"/>
                <geometry>
                    <mesh filename="file://$(find robot_arm_teleop)/mbracket.stl" scale="0.25 0.25 0.25"/>
                </geometry>
            </visual>
        </link>

        <joint name="mbracket_${index}_joint" type="fixed">
            <parent link="mbracket_${index}"/>
            <child link="servo_${index}"/>
        </joint>
    </xacro:macro>

    <!-- Ubracket Macro -->
    <xacro:macro name="ubracket" params="index">
        <link name="ubracket_${index}">
            <visual>
                <origin xyz="0 -0.52 0.275" rpy="0 ${pi/2} 0"/>
                <geometry>
                    <mesh filename="file://$(find robot_arm_teleop)/ubracket.stl" scale="0.01 0.01 0.01"/>
                </geometry>
            </visual>
        </link>
    </xacro:macro>

    <!-- Spacer Macro -->
    <xacro:macro name="spacer" params="index">
        <link name="spacer_${index}">
            <visual>
                <geometry>
                    <cylinder radius="0.1" length="0.08"/>
                </geometry>
            </visual>
        </link>
    </xacro:macro>

    <!-- Servo with UBracket -->
    <xacro:macro name="servo_u" params="index">

        <xacro:servo index="${index}" flipped="1"></xacro:servo>

        <xacro:ubracket index="${index}"></xacro:ubracket>

        <xacro:spacer index="${index}"></xacro:spacer>

        <joint name="servo${index}_u${index}" type="revolute">
            <axis xyz="0 0 1"/>
            <limit lower="${-pi/2}" upper="${pi/2}" effort="1000" velocity="${5/3}"/>
            <parent link="servo_${index}"/>
            <child link="ubracket_${index}"/>
            <origin xyz="0 0 -0.08" rpy="0 0 0"/>
        </joint>

        <joint name="u${index}_spacer${index}" type="fixed">
            <parent link="ubracket_${index}"/>
            <child link="spacer_${index}"/>
            <origin xyz="0 0 0.04" rpy="0 0 0"/>
        </joint>

    </xacro:macro>


    <link name="base_link"></link>

    <joint name="root_joint" type="fixed">
        <parent link="base_link"/>
        <child link="mbracket_1"/>
    </joint>

    <!-- Instantiate a Servo with a UBracket -->
    <xacro:servo_u index="1"></xacro:servo_u>
    <xacro:ubracket index="2"></xacro:ubracket>

    <joint name="u1_u2" type="fixed">
        <parent link="ubracket_1"/>
        <child link="ubracket_2"/>
        <origin xyz="0 -1 0" rpy="0 0 ${pi}"/>
    </joint>

</robot>